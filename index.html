<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phasmophobia Broads HQ — FULL SYSTEM</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: radial-gradient(circle at top, #09121a 0%, #05060a 60%, #010103 100%);
      color: #e0faff;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 0.5px;
      text-shadow: 0 0 4px #00eaff;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(0,255,255,0.12), transparent 70%),
        radial-gradient(circle at 80% 70%, rgba(255,0,150,0.10), transparent 60%);
      pointer-events: none;
      z-index: 1;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: 
        radial-gradient(circle, rgba(0,255,255,0.18) 2px, transparent 3px),
        radial-gradient(circle, rgba(255,0,170,0.18) 2px, transparent 3px),
        radial-gradient(circle, rgba(0,180,255,0.15) 3px, transparent 4px);
      background-size: 120px 120px, 180px 180px, 250px 250px;
      animation: floatParticles 40s linear infinite;
      z-index: 0;
    }
    @keyframes floatParticles {
      0% { transform: translate(0, 0); }
      100% { transform: translate(-300px, -300px); }
    }

    .tab-btn {
      padding: 10px 18px;
      background: #0a0f18;
      border: 1px solid #00eaff66;
      border-radius: 6px;
      transition: 0.25s;
      position: relative;
      overflow: hidden;
      color: #dffaff;
      font-weight: bold;
      text-shadow: 0 0 4px #00eaff;
    }
    .tab-btn:hover {
      background: #0ff4f422;
      box-shadow: 0 0 14px #00faff;
      filter: drop-shadow(0 0 6px #00faff) drop-shadow(0 0 12px #ff4ce1);
    }
    .tab-btn:active::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent, rgba(0,255,255,0.4), transparent);
      animation: shockwave 0.35s ease-out;
    }
    @keyframes shockwave {
      0% { opacity: 0.8; transform: scale(0.9); }
      60% { opacity: 0.3; transform: scale(1.4); }
      100% { opacity: 0; transform: scale(2); }
    }
    .tab-btn.active-glitch {
      position: relative;
    }
    .tab-btn.active-glitch::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #00eaff33, #ff4ce133);
      animation: glitchFlash .35s steps(3) forwards;
      pointer-events: none;
    }
    @keyframes glitchFlash {
      0% { clip-path: inset(0 0 70% 0); }
      33% { clip-path: inset(20% 0 30% 0); }
      66% { clip-path: inset(60% 0 5% 0); }
      100% { opacity: 0; }
    }

    .tab-panel {
      backdrop-filter: blur(6px);
      background: rgba(0,10,20,0.45);
      border: 1px solid #0ff4f466;
      border-radius: 8px;
      padding: 12px;
      box-shadow: inset 0 0 25px #00eaff33;
      animation: panelPulse 4s infinite ease-in-out;
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    @keyframes panelPulse {
      0% { box-shadow: inset 0 0 20px #00eaff33; }
      50% { box-shadow: inset 0 0 45px #00eaff66; }
      100% { box-shadow: inset 0 0 20px #00eaff33; }
    }
    .tab-panel.hidden {
      opacity: 0;
      transform: translateY(10px);
      filter: blur(2px);
      pointer-events: none;
    }

    #chat-messages,
    #evidence-display,
    #status-display {
      background: rgba(0,0,0,0.45);
      border: 1px solid #00eaff55;
      box-shadow: inset 0 0 12px #00eaff55;
      position: relative;
    }
    #chat-messages div {
      border: 1px solid #00eaff55;
      background: rgba(0,0,0,0.35);
      padding: 6px;
      margin-bottom: 6px;
      border-radius: 6px;
      transition: 0.25s;
    }
    #chat-messages div:hover {
      box-shadow: 0 0 14px #00eaffaa;
      border-color: #00faff;
    }

    #chat-input,
    input,
    select {
      background: #050912 !important;
      border: 1px solid #00eaff99;
      color: #c8f9ff;
      box-shadow: inset 0 0 10px #00d4ff55;
    }
    #chat-input::placeholder {
      color: #89d7ff;
      animation: typingPulse 1.2s infinite;
    }
    @keyframes typingPulse {
      0%,100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
  </style>
</head>
<body class="p-4">
  <div class="ghost-afterimage-layer"></div>
  <h1 class="text-3xl font-orbitron mb-6 text-center">Phasmophobia Broads HQ</h1>
  <div class="flex flex-wrap gap-3 items-center justify-center mb-8">
    <button class="tab-btn" data-tab="chat">Chat</button>
    <button class="tab-btn" data-tab="ghost">Ghost Profiles</button>
    <button class="tab-btn" data-tab="evidence">Evidence</button>
    <button class="tab-btn" data-tab="cases">Case Files</button>
    <button class="tab-btn" data-tab="status">Squad Status</button>
    <button class="tab-btn" data-tab="map">Map</button>
    <button class="tab-btn" data-tab="profile">Profile</button>
  </div>
  <div class="container mx-auto max-w-3xl space-y-6">
    <!-- CHAT TAB -->
    <div class="tab-panel" id="tab-chat" data-tab="chat">
      <h2 class="text-xl font-bold mb-3">Team Chat</h2>
      <button id="jitsi-btn"
              class="w-full mb-4 p-2 bg-cyan-400 text-black font-bold rounded shadow hover:bg-cyan-300">
        <i class="fas fa-video"></i> Start Voice/Video Call
      </button>
      <div id="chat-messages" class="h-64 overflow-y-auto bg-black/40 p-4 rounded mb-3"></div>
      <div id="ghost-activity-log" class="h-24 overflow-y-auto bg-black/30 p-2 rounded mb-3 text-xs"></div>
      <input id="chat-input"
             class="w-full p-2 bg-gray-900 rounded"
             placeholder="Type a message or !command" />
    </div>
    <!-- GHOST PROFILES -->
    <div class="tab-panel hidden" id="tab-ghost" data-tab="ghost">
      <h2 class="text-xl font-bold mb-3">Ghost Encyclopedia</h2>
      <select id="ghost-select" class="w-full p-2 rounded mb-4"></select>
      <div id="ghost-info" class="p-4 bg-black/40 rounded"></div>
    </div>
    <!-- EVIDENCE TAB -->
    <div class="tab-panel hidden" id="tab-evidence" data-tab="evidence">
      <h2 class="text-xl font-bold mb-3">Collected Evidence</h2>
      <div id="evidence-display" class="space-y-2"></div>
    </div>
    <!-- CASE FILES -->
    <div class="tab-panel hidden" id="tab-cases" data-tab="cases">
      <h2 class="text-xl font-bold mb-3">Case Files Gallery</h2>
      <div id="case-files-gallery" class="grid grid-cols-2 gap-4"></div>
    </div>
    <!-- SQUAD STATUS -->
    <div class="tab-panel hidden" id="tab-status" data-tab="status">
      <h2 class="text-xl font-bold mb-3">Squad Status</h2>
      <div id="status-display" class="space-y-3"></div>
    </div>
    <!-- MAP TAB -->
    <div class="tab-panel hidden" id="tab-map" data-tab="map">
      <h2 class="text-xl font-bold mb-3">Current Investigation Map</h2>
      <img id="map-location-image" class="w-full rounded border border-cyan-400" />
    </div>
    <!-- PROFILE TAB -->
    <div class="tab-panel hidden" id="tab-profile" data-tab="profile">
      <h2 class="text-xl font-bold mb-3">Your Profile</h2>
      <div class="space-y-3">
        <input id="display-name-input"
               class="w-full p-2 rounded"
               placeholder="Display Name" />
        <select id="photo-select" class="w-full p-2 rounded">
          <option value="/assets/profiles/default.jpg">Default</option>
        </select>
        <img id="profile-preview"
             class="w-20 h-20 rounded-full border border-cyan-400" />
        <button id="profile-save-btn"
                class="w-full bg-cyan-300 text-black p-2 rounded">
          Save Profile
        </button>
      </div>
    </div>
  </div>
  <div id="case-file-modal"
       class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4">
    <div class="bg-gray-900 p-4 rounded w-full max-w-md">
      <img id="modal-image" class="rounded mb-2" />
      <h2 id="modal-title" class="text-xl font-bold mb-1"></h2>
      <p id="modal-description" class="text-gray-300 mb-4"></p>
      <button onclick="closeModal()"
              class="w-full bg-cyan-300 text-black p-2 rounded">
        Close
      </button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      setDoc,
      doc,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2WA7yotRlqNidwIgJcT19JNrK8ukMgs4",
      authDomain: "phasmophobiabroads.firebaseapp.com",
      projectId: "phasmophobiabroads",
      storageBucket: "phasmophobiabroads.appspot.com",
      messagingSenderId: "503659624108",
      appId: "1:503659624108:web:6e57fbc6bf36b0d5989109",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let CURRENT_USER_ID = null;

    async function ensureAuth() {
      return new Promise((resolve, reject) => {
        onAuthStateChanged(auth, async (user) => {
          try {
            if (!user) {
              const anon = await signInAnonymously(auth);
              CURRENT_USER_ID = anon.user.uid;
            } else {
              CURRENT_USER_ID = user.uid;
            }
            resolve(CURRENT_USER_ID);
          } catch (err) {
            console.error("Auth error:", err);
            reject(err);
          }
        });
      });
    }

    function safeUser() {
      if (!CURRENT_USER_ID) {
        console.warn("No authenticated user yet.");
        return false;
      }
      return true;
    }

    const GHOST_DATA = {
      Spirit:{evidence:["EMF 5","Spirit Box","Writing"],strength:"No specific strengths.",weakness:"Smudge sticks stop attacks longer."},
      Wraith:{evidence:["EMF 5","Spirit Box","DOTS"],strength:"Doesn't step on salt.",weakness:"Salt cripples it."},
      Phantom:{evidence:["Spirit Box","Fingerprints","DOTS"],strength:"Looking at it drains sanity.",weakness:"Photo makes it vanish."},
      Poltergeist:{evidence:["Spirit Box","Fingerprints","Writing"],strength:"Throws multiple objects.",weakness:"Weak in empty rooms."},
      Banshee:{evidence:["Fingerprints","DOTS","Orb"],strength:"Targets a single player.",weakness:"Crucifix more effective."},
      Jinn:{evidence:["EMF 5","Fingerprints","Freezing"],strength:"Fast at range.",weakness:"Power off makes it weaker."},
      Mare:{evidence:["Spirit Box","Orb","Writing"],strength:"Thrives in darkness.",weakness:"Light reduces hunts."},
      Revenant:{evidence:["Orb","Writing","Freezing"],strength:"Extremely fast during hunts.",weakness:"Slow when wandering."},
      Shade:{evidence:["EMF 5","Writing","Freezing"],strength:"Shy ghost.",weakness:"Can't hunt if 2+ players near."},
      Demon:{evidence:["Fingerprints","Writing","Freezing"],strength:"Very early hunts.",weakness:"Crucifix much stronger."},
      Yurei:{evidence:["Orb","Freezing","DOTS"],strength:"Strong sanity drain.",weakness:"Smudging locks it inside room."},
      Oni:{evidence:["EMF 5","Freezing","DOTS"],strength:"Very active.",weakness:"Easy to spot."},
      Yokai:{evidence:["Spirit Box","Orb","DOTS"],strength:"Triggered by talking.",weakness:"Can't hear far voices."},
      Hantu:{evidence:["Fingerprints","Orb","Freezing"],strength:"Fast in cold.",weakness:"Slow in warm."},
      Goryo:{evidence:["EMF 5","Fingerprints","DOTS"],strength:"Only on-camera.",weakness:"Rarely leaves room."},
      Myling:{evidence:["EMF 5","Fingerprints","Writing"],strength:"Quiet during hunts.",weakness:"Parabolic hears footsteps."},
      Onryo:{evidence:["Spirit Box","Orb","Freezing"],strength:"Triggered by flames.",weakness:"Candles protect."},
      Twins:{evidence:["Spirit Box","EMF 5","Freezing"],strength:"Two activity sources.",weakness:"Different EMF patterns."},
      Raiju:{evidence:["EMF 5","DOTS","Orb"],strength:"Fast near electronics.",weakness:"Causes EMF surges."},
      Obake:{evidence:["EMF 5","Fingerprints","Orb"],strength:"Mutates fingerprints.",weakness:"Fingerprints disappear quickly."},
      Mimic:{evidence:["Spirit Box","Freezing","Fingerprints","Orb"],strength:"Copies any ghost.",weakness:"Always shows orbs."},
      Moroi:{evidence:["Spirit Box","Writing","Freezing"],strength:"Curses players.",weakness:"Smudge blinds longer."},
      Deogen:{evidence:["Spirit Box","Writing","DOTS"],strength:"Reads players.",weakness:"Slow up close."},
      Thaye:{evidence:["Orb","Writing","DOTS"],strength:"Very active early.",weakness:"Weakens over time."}
    };

    const MAP_DATA = {
      Grafton:{name:"Grafton Farmhouse",url:"/assets/maps/grafton.jpg"},
      Tanglewood:{name:"Tanglewood Street House",url:"/assets/maps/tanglewood.jpg"},
      Edgefield:{name:"Edgefield Street House",url:"/assets/maps/edgefield.jpg"},
      Ridgeview:{name:"Ridgeview Road House",url:"/assets/maps/ridgeview.jpg"},
      Willow:{name:"Willow Street House",url:"/assets/maps/willow.jpg"},
      Bleasdale:{name:"Bleasdale Farmhouse",url:"/assets/maps/bleasdale.jpg"},
      Brownstone:{name:"Brownstone High School",url:"/assets/maps/brownstone.jpg"}
    };
    const DEFAULT_MAP = "https://placehold.co/600x300/0a0a0f/5dfdff?text=Map+Not+Set";

    const BROAD_IMAGES = [
      {url:"/assets/profiles/case1.jpg", title:"The Silent Approach", description:"Case File 001"},
      {url:"/assets/profiles/case2.jpg", title:"Closet Panic", description:"Case File 002"},
      {url:"/assets/profiles/case3.jpg", title:"Emergency Extraction", description:"Case File 003"},
      {url:"/assets/profiles/case4.jpg", title:"Ouija Board Gamble", description:"Case File 004"},
      {url:"/assets/profiles/case5.jpg", title:"The Voodoo Threat", description:"Case File 005"},
      {url:"/assets/profiles/case6.jpg", title:"Circle of Summoning", description:"Case File 006"},
    ];

    // UI RENDER FUNCTIONS
    function renderChat(messages) {
      const box = document.getElementById("chat-messages");
      if (!box) return;
      box.innerHTML = "";
      messages.forEach(msg => {
        const time = new Date(msg.timestamp).toLocaleTimeString("en-US",{hour12:false});
        const div = document.createElement("div");
        div.innerHTML = `
          <div class="flex items-start space-x-3 mb-2">
            <img class="w-7 h-7 rounded-full border border-cyan-300"
                 src="${msg.photoUrl || "/assets/profiles/default.jpg"}" />
            <div class="flex-grow">
              <span class="text-xs text-gray-500">${time}</span>
              <span class="font-bold text-cyan-300 ml-2">
                ${msg.displayName || "User"}:
              </span>
              <span class="${msg.isCommand ? "text-pink-400" : "text-gray-200"}">
                ${msg.text}
              </span>
            </div>
          </div>`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }
    function renderEvidence(list) {
      const box = document.getElementById("evidence-display");
      if (!box) return;
      box.innerHTML = "";
      list.forEach(ev => {
        box.innerHTML += `
          <div class="p-3 border-l-4 border-cyan-300 bg-white/5 rounded-md flex justify-between">
            <span class="text-cyan-300 font-bold">${ev.evidence}</span>
            <span class="text-xs text-gray-400">By ${ev.displayName || "User"}</span>
          </div>`;
      });
    }
    function populateGhostDropdown() {
      const sel = document.getElementById("ghost-select");
      if (!sel) return;
      sel.innerHTML = '<option value="">Select Ghost</option>';
      Object.keys(GHOST_DATA).sort().forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }
    function renderGhostProfile(name) {
      const info = document.getElementById("ghost-info");
      if (!info) return;
      if (!name || !GHOST_DATA[name]) {
        info.innerHTML = "<p class='text-gray-400'>Select a ghost.</p>";
        return;
      }
      const g = GHOST_DATA[name];
      info.innerHTML = `
        <h4 class="text-xl font-bold text-cyan-300">${name}</h4>
        <div class="border-b border-cyan-500/50 my-2"></div>
        <p><span class="text-cyan-400 font-bold">Evidence:</span> ${g.evidence.join(", ")}</p>
        <p><span class="text-cyan-400 font-bold">Strength:</span> ${g.strength}</p>
        <p><span class="text-cyan-400 font-bold">Weakness:</span> ${g.weakness}</p>
      `;
    }
    function populateCaseFiles() {
      const g = document.getElementById("case-files-gallery");
      if (!g) return;
      g.innerHTML = "";
      BROAD_IMAGES.forEach((item, i) => {
        const img = document.createElement("img");
        img.src = item.url;
        img.className =
          "w-full h-32 object-cover rounded-lg border-2 border-cyan-300 cursor-pointer hover:border-pink-400";
        img.onclick = () => openCaseFileModal(i);
        g.appendChild(img);
      });
    }
    function openCaseFileModal(i) {
      const m = BROAD_IMAGES[i];
      document.getElementById("modal-image").src = m.url;
      document.getElementById("modal-title").textContent = m.title;
      document.getElementById("modal-description").textContent = m.description;
      document.getElementById("case-file-modal").classList.remove("hidden");
    }
    window.closeModal = function () {
      document.getElementById("case-file-modal").classList.add("hidden");
    };
    function renderSquadStatus(statuses, profiles) {
      const box = document.getElementById("status-display");
      box.innerHTML = "";
      Object.values(statuses).forEach(st => {
        const prof = profiles[st.userId] || {};
        const dead = st.isDead;
        box.innerHTML += `
          <div class="flex items-center space-x-3 p-4 rounded border-2 ${
            dead ? "border-red-500" : "border-green-500"
          } bg-white/5">
            <img class="w-10 h-10 rounded-full border border-cyan-300"
                 src="${prof.photoUrl || "/assets/profiles/default.jpg"}" />
            <div class="flex-grow">
              <span class="font-bold text-white">${prof.displayName || "Unknown"}</span>
              <div class="text-sm text-gray-400">
                ${dead ? "DECEASED" : `${st.map || "Unknown Map"} — ${st.location || "Unknown Room"}`}
              </div>
            </div>
            <i class="fas ${
              dead ? "fa-skull text-red-500" : "fa-heartbeat text-green-500"
            } text-2xl"></i>
          </div>`;
      });
    }
    function renderMap(name) {
      const img = document.getElementById("map-location-image");
      img.src = MAP_DATA[name]?.url || DEFAULT_MAP;
    }
    async function sendChatMessage(text, isCommand = false) {
      if (!safeUser()) return;
      await addDoc(collection(db, "/app/chat"), {
        userId: CURRENT_USER_ID,
        text,
        isCommand,
        timestamp: Date.now()
      });
    }
    async function saveEvidence(evidence) {
      if (!safeUser()) return;
      await addDoc(collection(db, "/app/evidence"), {
        userId: CURRENT_USER_ID,
        evidence,
        timestamp: Date.now()
      });
    }
    async function updatePlayerStatus(updateObj) {
      if (!safeUser()) return;
      await setDoc(doc(db, "/app/status", CURRENT_USER_ID), {
        ...updateObj,
        userId: CURRENT_USER_ID,
        timestamp: Date.now()
      }, { merge: true });
    }
    async function saveUserProfile(name, photo) {
      if (!safeUser()) return;
      await setDoc(doc(db, "/app/profiles", CURRENT_USER_ID), {
        displayName: name,
        photoUrl: photo,
        lastSeen: Date.now()
      }, { merge: true });
    }
    const latest = { profiles:{}, statuses:{} };
    function startRealtimeListeners() {
      const chatRef = query(collection(db, "/app/chat"), orderBy("timestamp", "asc"));
      onSnapshot(chatRef, snap => {
        const msgs = [];
        snap.forEach(d => msgs.push(d.data()));
        renderChat(msgs);
      });
      onSnapshot(collection(db, "/app/evidence"), snap => {
        const list = [];
        snap.forEach(d => list.push(d.data()));
        renderEvidence(list);
      });
      onSnapshot(collection(db, "/app/status"), snap => {
        const s = {};
        snap.forEach(d => s[d.id] = d.data());
        latest.statuses = s;
        renderSquadStatus(s, latest.profiles);
      });
      onSnapshot(collection(db, "/app/profiles"), snap => {
        const p = {};
        snap.forEach(d => p[d.id] = d.data());
        latest.profiles = p;
        renderSquadStatus(latest.statuses, p);
        const sel = document.getElementById("photo-select");
        if (sel) {
          sel.innerHTML = '<option value="/assets/profiles/default.jpg">Default</option>';
          Object.entries(p).forEach(([uid, prof]) => {
            if (prof.photoUrl) {
              const opt = document.createElement("option");
              opt.value = prof.photoUrl;
              opt.textContent = prof.displayName || uid;
              sel.appendChild(opt);
            }
          });
        }
      });
    }
    function switchTab(tabName) {
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.add("hidden"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active-glitch"));
      const panel = document.querySelector(`.tab-panel[data-tab="${tabName}"]`);
      const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      if (panel) panel.classList.remove("hidden");
      if (btn) btn.classList.add("active-glitch");
    }
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });
    switchTab("chat");
    document.getElementById("jitsi-btn")?.addEventListener("click", () => {
      window.open(
        "https://meet.jit.si/PhasmophobiaBroadsHQ",
        "_blank",
        "width=900,height=650"
      );
    });
    async function boot() {
      await ensureAuth();
      populateGhostDropdown();
      populateCaseFiles();
      startRealtimeListeners();
      document.getElementById("ghost-select").addEventListener("change", e => {
        renderGhostProfile(e.target.value);
      });
    }
    boot();
  </script>
</body>
</html>
